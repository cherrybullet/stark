}                                               

  private enum ClassType {                        
    NONE,                                         
    CLASS                                         
  }

  private ClassType currentClass = ClassType.NONE;

  void resolve(List<Stmt> statements) {           
lox/Resolver.java, add after enum FunctionType


public Void visitClassStmt(Stmt.Class stmt) {
    ClassType enclosingClass = currentClass;   
    currentClass = ClassType.CLASS;            

    declare(stmt.name);                        
lox/Resolver.java, in visitClassStmt()





endScope();                   
    currentClass = enclosingClass;
    return null;                  
lox/Resolver.java, in visitClassStmt()






public Void visitThisExpr(Expr.This expr) {      
    if (currentClass == ClassType.NONE) {          
      Lox.error(expr.keyword,                      
          "Cannot use 'this' outside of a class.");
      return null;                                 
    }                                              

    resolveLocal(expr, expr.keyword);              
lox/Resolver.java, in visitThisExpr()



public Object call(Interpreter interpreter, List<Object> arguments) {
    LoxInstance instance = new LoxInstance(this);                      
    LoxFunction initializer = findMethod("init");                      
    if (initializer != null) {                                         
      initializer.bind(instance).call(interpreter, arguments);         
    }                                                                  

    return instance;                                                   
lox/LoxClass.java, in call()




public int arity() {                           
    LoxFunction initializer = findMethod("init");
    if (initializer == null) return 0;           
    return initializer.arity();                  
  }                                              
lox/LoxClass.java, in arity(), replace 1 line


return returnValue.value;                        
    }                                                  

    if (isInitializer) return closure.getAt(0, "this");
    return null;                                       
lox/LoxFunction.java, in call()




private final Environment closure;                         
  private final boolean isInitializer;

  LoxFunction(Stmt.Function declaration, Environment closure,
              boolean isInitializer) {                       
    this.isInitializer = isInitializer;                      
    this.closure = closure;                                  
    this.declaration = declaration;                          
lox/LoxFunction.java, in class LoxFunction, replace 1 line



public Void visitFunctionStmt(Stmt.Function stmt) {                
    LoxFunction function = new LoxFunction(stmt, environment, false);
    environment.define(stmt.name.lexeme, function);                  
lox/Interpreter.java, in visitFunctionStmt(), replace 1 line



for (Stmt.Function method : stmt.methods) {                  
      LoxFunction function = new LoxFunction(method, environment,
          method.name.lexeme.equals("init"));                    
      methods.put(method.name.lexeme, function);                 
lox/Interpreter.java, in visitClassStmt(), replace 1 line



environment.define("this", instance);                           
    return new LoxFunction(declaration, environment, isInitializer);
  }                                                                 
lox/LoxFunction.java, in bind(), replace 1 line



FUNCTION,   
    INITIALIZER,
    METHOD      
lox/Resolver.java, in enum FunctionType



FunctionType declaration = FunctionType.METHOD;
      if (method.name.lexeme.equals("init")) {        
        declaration = FunctionType.INITIALIZER;       
      }                                               

      resolveFunction(method, declaration);
lox/Resolver.java, in visitClassStmt()



if (stmt.value != null) {                             
      if (currentFunction == FunctionType.INITIALIZER) {  
        Lox.error(stmt.keyword,                           
            "Cannot return a value from an initializer.");
      }                                                   

      resolve(stmt.value);                                
lox/Resolver.java, in visitReturnStmt()





} catch (Return returnValue) {                       
      if (isInitializer) return closure.getAt(0, "this");

      return returnValue.value;                          
lox/LoxFunction.java, in call()
